/**
 * vCardJS - a vCard 4.0 implementation in JavaScript
 *
 * (c) 2012 - Niklas Cathor
 *
 * Latest source: https://github.com/nilclass/vcardjs
 **/define("vcardjs",function(){(function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var r=e,i=[],s;n=n||r.length;if(t)for(s=0;s<t;s++)i[s]=r[0|Math.random()*n];else{var o;i[8]=i[13]=i[18]=i[23]="-",i[14]="4";for(s=0;s<36;s++)i[s]||(o=0|Math.random()*16,i[s]=r[s==19?o&3|8:o])}return i.join("")},Math.uuidFast=function(){var t=e,n=new Array(36),r=0,i;for(var s=0;s<36;s++)s==8||s==13||s==18||s==23?n[s]="-":s==14?n[s]="4":(r<=2&&(r=33554432+Math.random()*16777216|0),i=r&15,r>>=4,n[s]=t[s==19?i&3|8:i]);return n.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}})();var e;(function(){e=function(e){this.changed=!1;if(typeof e=="object")for(var t in e)this[t]=e[t],this.changed=!0},e.prototype={validate:function(){function n(e,n){t.push([e,n])}function i(e,n){for(var r in n){var i=n[r];typeof i!="object"?t.push([e+"-"+r,"not-an-object"]):i.type?i.value||t.push([e+"-"+r,"missing-value"]):t.push([e+"-"+r,"missing-type"])}}var t=[];this.fn||n("fn","required");for(var r in e.multivaluedKeys)this[r]&&!(this[r]instanceof Array)&&(this[r]=[this[r]]);return this.email&&i("email",this.email),this.tel&&i("email",this.tel),this.uid||this.addAttribute("uid",this.generateUID()),this.rev||this.addAttribute("rev",this.generateRev()),this.errors=t,!(t.length>0)},generateUID:function(){return"uuid:"+Math.uuid()},generateRev:function(){return(new Date).toISOString().replace(/[\.\:\-]/g,"")},setAttribute:function(e,t){this[e]=t,this.changed=!0},addAttribute:function(t,n){if(!n)return;e.multivaluedKeys[t]?this[t]?this[t].push(n):this.setAttribute(t,[n]):this.setAttribute(t,n)},toJSON:function(){return JSON.stringify(this.toJCard())},toJCard:function(){var t={};for(var n in e.allKeys){var r=e.allKeys[n];this[r]&&(t[r]=this[r])}return t},merge:function(t){function r(e){t[e]?t[e]==this[e]?n.setAttribute(this[e]):(n.addAttribute(this[e]),n.addAttribute(t[e])):n[e]=this[e]}if(typeof t.uid!="undefined"&&typeof this.uid!="undefined"&&t.uid!==this.uid)throw"Won't merge vcards without matching UIDs.";var n=new e;for(key in this)r(key);for(key in t)n[key]||r(key)}},e.enums={telType:["text","voice","fax","cell","video","pager","textphone"],relatedType:["contact","acquaintance","friend","met","co-worker","colleague","co-resident","neighbor","child","parent","sibling","spouse","kin","muse","crush","date","sweetheart","me","agent","emergency"],emailType:["work","home","internet"],langType:["work","home"]},e.allKeys=["fn","n","nickname","photo","bday","anniversary","gender","tel","email","impp","lang","tz","geo","title","role","logo","org","member","related","categories","note","prodid","rev","sound","uid"],e.multivaluedKeys={email:!0,tel:!0,geo:!0,title:!0,role:!0,logo:!0,org:!0,member:!0,related:!0,categories:!0,note:!0}})();var t;return function(){t={simpleKeys:["VERSION","FN","PHOTO","GEO","TITLE","ROLE","LOGO","MEMBER","NOTE","PRODID","SOUND","UID"],csvKeys:["NICKNAME","CATEGORIES"],dateAndOrTimeKeys:["BDAY","ANNIVERSARY","REV"],parse:function(t,n,r){var i=null;r||(r=this),this.lex(t,function(t,s,o){function u(e){i&&i.addAttribute(t.toLowerCase(),e)}if(t=="BEGIN")i=new e;else if(t=="END")i&&(n.apply(r,[i]),i=null);else if(this.simpleKeys.indexOf(t)!=-1)u(s);else if(this.csvKeys.indexOf(t)!=-1)u(s.split(","));else if(this.dateAndOrTimeKeys.indexOf(t)!=-1)o.VALUE=="text"?u(s):(!o.CALSCALE||o.CALSCALE=="gregorian")&&u(this.parseDateAndOrTime(s));else if(t=="N")u(this.parseName(s));else if(t=="GENDER")u(this.parseGender(s));else if(t=="TEL")u({type:o.TYPE||"voice",pref:o.PREF,value:s});else if(t=="EMAIL")u({type:o.TYPE,pref:o.PREF,value:s});else if(t=="IMPP")u({value:s});else if(t=="LANG")u({type:o.TYPE,pref:o.PREF,value:s});else if(t=="TZ")o.VALUE=="utc-offset"?u({"utc-offset":this.parseTimezone(s)}):u({name:s});else if(t=="ORG"){var a=s.split(";");u({"organization-name":a[0],"organization-unit":a[1]})}else t=="RELATED"?u({type:o.TYPE,pref:o.PREF,value:o.VALUE}):t=="ADR"?u({type:o.TYPE,pref:o.PREF,value:s}):console.log("WARNING: unhandled key: ",t)})},nameParts:["family-name","given-name","additional-name","honorific-prefix","honorific-suffix"],parseName:function(e){var t=e.split(";"),n={};for(var r in t)t[r]&&(n[this.nameParts[r]]=t[r].split(","));return n},parseGender:function(e){var t={},n=e.split(";");switch(n[0]){case"M":t.sex="male";break;case"F":t.sex="female";break;case"O":t.sex="other"}return n[1]&&(t.identity=n[1]),t},dateRE:/^(\d{4})(\d{2})(\d{2})$/,dateReducedARE:/^(\d{4})\-(\d{2})$/,dateReducedBRE:/^(\d{4})$/,dateTruncatedMDRE:/^\-{2}(\d{2})(\d{2})$/,dateTruncatedDRE:/^\-{3}(\d{2})$/,timeRE:/^(\d{2})(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeReducedARE:/^(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeReducedBRE:/^(\d{2})([+\-]\d+|Z|)$/,timeTruncatedMSRE:/^\-{2}(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeTruncatedSRE:/^\-{3}(\d{2})([+\-]\d+|Z|)$/,parseDate:function(e){var t,n,r,i;if(t=e.match(this.dateRE))n=t[1],r=t[2],i=t[3];else if(t=e.match(this.dateReducedARE))n=t[1],r=t[2];else if(t=e.match(this.dateReducedBRE))n=t[1];else if(t=e.match(this.dateTruncatedMDRE))r=t[1],i=t[2];else{if(!(t=e.match(this.dateTruncatedDRE)))return console.error("WARNING: failed to parse date: ",e),null;i=t[1]}var s=new Date(0);return typeof n!="undefined"&&s.setUTCFullYear(n),typeof r!="undefined"&&s.setUTCMonth(r-1),typeof i!="undefined"&&s.setUTCDate(i),s},parseTime:function(e){var t,n,r,i,s;if(t=e.match(this.timeRE))n=t[1],r=t[2],i=t[3],s=t[4];else if(t=e.match(this.timeReducedARE))n=t[1],r=t[2],s=t[3];else if(t=e.match(this.timeReducedBRE))n=t[1],s=t[2];else if(t=e.match(this.timeTruncatedMSRE))r=t[1],i=t[2],s=t[3];else{if(!(t=e.match(this.timeTruncatedSRE)))return console.error("WARNING: failed to parse time: ",e),null;i=t[1],s=t[2]}var o=new Date(0);return typeof n!="undefined"&&o.setUTCHours(n),typeof r!="undefined"&&o.setUTCMinutes(r),typeof i!="undefined"&&o.setUTCSeconds(i),s&&(o=this.applyTimezone(o,s)),o},addDates:function(e,t,n){typeof n=="undefined"&&(n=!0);if(!e)return t;if(!t)return e;var r=Number(e),i=Number(t),s=n?r+i:r-i;return new Date(s)},parseTimezone:function(e){var t;if(t=e.match(/^([+\-])(\d{2})(\d{2})?/)){var n=new Date(0);return n.setUTCHours(t[2]),n.setUTCMinutes(t[3]||0),Number(n)*(t[1]=="+"?1:-1)}return null},applyTimezone:function(e,t){var n=this.parseTimezone(t);return n?new Date(Number(e)+n):e},parseDateTime:function(e){var t=e.split("T"),n=this.parseDate(t[0]),r=this.parseTime(t[1]);return this.addDates(n,r)},parseDateAndOrTime:function(e){switch(e.indexOf("T")){case 0:return this.parseTime(e.slice(1));case-1:return this.parseDate(e);default:return this.parseDateTime(e)}},lineRE:/^([^\s].*)(?:\r?\n|$)/,foldedLineRE:/^\s(.+)(?:\r?\n|$)/,lex:function(e,t){var n,r=null,i=0;for(;;){(n=e.match(this.lineRE))?r&&r.indexOf("QUOTED-PRINTABLE")!=-1&&r.slice(-1)=="="?(r=r.slice(0,-1)+n[1],i=n[0].length):(r&&this.lexLine(r,t),r=n[1],i=n[0].length):(n=e.match(this.foldedLineRE))?r&&(r+=n[1],i=n[0].length):console.error("Unmatched line: "+r),e=e.slice(i);if(!e)break}r&&this.lexLine(r,t),r=null},lexLine:function(e,t){function a(){r?o?i[o]=n.split(","):n=="PREF"?i.PREF=1:i.TYPE?i.TYPE.push(n):i.TYPE=[n]:r=n}var n="",r=null,i={},s=null,o=null,u=e.indexOf("ENCODING=QUOTED-PRINTABLE");u!=-1&&(e=e.substr(0,u)+this.decodeQP(e.substr(u+25)));for(var f in e){var l=e[f];switch(l){case":":a(),s=e.slice(Number(f)+1),t.apply(this,[r,s,i]);return;case";":a(),n="";break;case"=":o=n,n="";break;default:n+=l}}},decodeQP:function(e){e=(e||"").toString(),e=e.replace(/\=(?:\r?\n|$)/g,"");var t="";for(var n=0,r=e.length;n<r;n++){chr=e.charAt(n);if(chr=="="&&(hex=e.substr(n+1,2))&&/[\da-fA-F]{2}/.test(hex)){t+=String.fromCharCode(parseInt(hex,16)),n+=2;continue}t+=chr}return t}}}(),{VCF:t,VCard:e}});